---
title: "Missing value analysis"
subtitle: "Data version: v2"
author: "Janko Thyson"
date: "2018-03-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all(here::here())
library(naniar)
# library(tidyverse)
library(dplyr)
library(ggplot2)
# install.packages("ggplot2")
library(plotly)
library(simputation)
```

## Read station data 

```{r}
dat_station <- data_read_station(dtype = "tidy", vsn = "v2")
# dat_station %>% glimpse()
```

## Full join {.tabset}

### Inspect

```{r}
dat_join_full <- data_read_join_full(vsn = "v2") 
# dat_join_full %>% glimpse()

# dat_join_full_sub <- dat_join_full %>% 
#   select(dim_station, starts_with("time"), starts_with("msr_"))
# dat_join_full_sub %>% glimpse()
```

### Visualize missing value structure

```{r}
visdat::vis_dat(dat_join_full)
```

```{r}
visdat::vis_miss(dat_join_full)
```

```{r}
gg_miss_var(dat_join_full)
gg_miss_var(dat_join_full, show_pct = TRUE)
```

```{r}
# ggplot(dat_join_full, 
#   aes(x = msr_temp_min, 
#     y = msr_sundur_avg)) + 
#   geom_miss_point() + 
#   facet_wrap(~time_month)
```

### Missing values by measure and country

```{r}
dat <- dat_join_full %>% 
  left_join(dat_station %>% select(dim_station, dim_country, dim_longitude, 
    dim_latitude, dim_high),
    by = "dim_station")

# dat %>% gg_miss_var(facet = dim_country)
# -> results in very big viz in which one particular country is too tiny to gain
# insights from
# dat_shadow <- bind_shadow(dat)
# dat_shadow %>% glimpse()
# res <- dat_shadow %>% 
#   group_by(dim_country) %>%
#   select(dim_country, ends_with("NA")) %>%
#   # select(dim_country, ends_with("NA")) %>%
#   # count(msr_temp_min_NA)
#     # map( function(x) dplyr::count(x))
#   # map(table)
#   map_df(function(x) select(ends_with("NA")) %>% data.frame(as.list(table(x))))
# bind_rows(res, .id = "names")

dat_sum_na <- dat %>% 
  group_by(dim_country) %>% 
  select(dim_country, starts_with("msr_")) %>% 
  summarise_all(funs(na = sum(is.na(.))))

dat_nor <- dat %>% 
  group_by(dim_country) %>% 
  summarise(nor = n())

dat_na <- dat_nor %>% 
  left_join(dat_sum_na, by = "dim_country") %>% 
  group_by(dim_country) %>% 
  # mutate_if(is.numeric, funs(rel = . / nor))
  mutate_at(vars(ends_with("na")), funs(rel = . / nor)) %>% 
  ungroup()
# dat_na %>% select(dim_country, msr_temp_min_na, nor, msr_temp_min_na_rel)  

dat_na_rel <- dat_na %>% select(dim_country, ends_with("rel"))
dat_na_rel_gathered <- tidyr::gather(dat_na_rel, key, value, -dim_country)
dat_na_rel_gathered_grouped <- dat_na_rel_gathered %>% 
  select(key, dim_country, value) %>%
  group_by(key) %>% 
  arrange(key, desc(value)) %>% 
  ungroup()
# dat_na_rel_gathered_grouped %>% View()

plot_missing_values <- function(dat) {
  lapply(unique(dat$key), function(key_value) {
  # -> needs to happen via a 'for' loop
  # out <- NULL
  # for (key_value in unique(dat$key)) {
    dat_plot <- dat %>% filter(key == key_value, value > 0) %>% 
      mutate(dim_country = factor(dim_country, levels = dim_country))
    
    p <- ggplot(dat_plot, aes(x = dim_country, y = value, fill = dim_country)) + 
      geom_bar(stat = "identity") +
      # geom_bar(stat = "identity") +
      ggtitle(sprintf("Percentage of missing values by country (%s)", 
        key_value)) +
      # scale_fill_discrete(guide = guide_legend()) +
      theme(
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.title = element_text(size = 8),
        legend.position = "bottom"
      ) #+
      # facet_wrap(~ key)
    
    # p_plotly <- suppressMessages(ggplotly(p))
    # # print(p_plotly)
    # out <- c(out, p_plotly)
    # out <- c(out, p)
    print(p)
    p
  })
  # out
}

plots <- plot_missing_values(dat_na_rel_gathered_grouped)
```

### Impute missing values {.tabset}

#### Idea

Impute missing values via the following regression model:

> `<variable> = dim_longitude + dim_latitude + dim_high`

#### Test goodness of fit

```{r}
reg_mod <- lm(msr_temp_min ~ dim_longitude + dim_latitude + 
    dim_high, data = dat)
summary(reg_mod)
# -> okay, but let's try to get better

reg_mod_2 <- lm(msr_temp_min ~ msr_precip_min + msr_precip_max + 
    msr_precip_avg + msr_sundur_avg, data = dat)
summary(reg_mod_2)

reg_mod_3 <- lm(msr_temp_min ~ msr_precip_avg + msr_sundur_avg, data = dat)
summary(reg_mod_3)

reg_mod_4 <- lm(msr_temp_min ~ 
    dim_longitude + 
    dim_latitude + 
    dim_high + 
    msr_precip_min +
    msr_precip_max +
    msr_precip_avg + 
    msr_sundur_avg, 
  data = dat)
summary(reg_mod_4)
# -> let's go with this one for now
```

**INSIGHT**: not a great model, but should do for now.
**TODO**: revise model at some point

#### Impute missing values via above-stated model #4

```{r}
# Modified formula due to problems with 'impute_lm' -----
dat_2 <- dat %>% impute_lm(
  msr_temp_min + msr_temp_max + msr_temp_avg ~ 
    dim_longitude + dim_latitude + dim_high + msr_precip_avg + msr_sundur_avg)
dat_2 <- dat_2 %>% impute_lm(
  msr_precip_min + msr_precip_max + msr_precip_avg + msr_precip_med ~ 
    dim_longitude + dim_latitude + dim_high + msr_temp_avg + msr_sundur_avg)
dat_2 <- dat_2 %>% impute_lm(msr_sundur_avg ~ dim_longitude + dim_latitude + 
    dim_high + msr_precip_avg + msr_temp_avg )
dat_2 <- dat_2 %>% impute_lm(msr_sundur_avg ~ dim_longitude + dim_latitude + 
    dim_high)

# Second wave with simpler model for remaining missing values -----
dat_2 <- dat_2 %>% impute_lm(
  msr_temp_min + msr_temp_max + msr_temp_avg +
    msr_precip_min + msr_precip_max + msr_precip_avg + 
    msr_sundur_avg ~ 
    dim_longitude + dim_latitude + dim_high)

# sum(is.na(dat$msr_temp_min))
# sum(is.na(dat_2$msr_temp_min))
# sum(is.na(dat$msr_precip_min))
# sum(is.na(dat_2$msr_precip_min))
# sum(is.na(dat$msr_sundur_avg))
# sum(is.na(dat_2$msr_sundur_avg))
```

#### Check results on missing value structure

```{r}
visdat::vis_dat(dat_2)
visdat::vis_miss(dat_2)
gg_miss_var(dat_2)
gg_miss_var(dat_2, show_pct = TRUE)
```

#### Conclusions

* Add missing value imputation to data preprocessing pipe
* This is reflected in data version `v3` and realized via function `data_trans_impute_missing_values`

## Inner join {.tabset}

NOTE: only dev-stage as focus was on `dat_join_full`

### Inspect

```{r}
dat_join_inner <- data_read_join_inner() %>% 
  select(starts_with("time"), starts_with("msr_"))
dat_join_inner %>% glimpse()
```

### Visualize missing value structure

```{r}
visdat::vis_dat(dat_join_inner)
```

```{r}
visdat::vis_miss(dat_join_inner)
```

```{r}
gg_miss_var(dat_join_inner)
gg_miss_var(dat_join_inner, show_pct = TRUE)
```

```{r}
# ggplot(dat_join_inner, 
#   aes(x = msr_temp_min, 
#     y = msr_sundur_avg)) + 
#   geom_miss_point() + 
#   facet_wrap(~ time_month)
```
