---
title: "Climate app demo"
author: "Janko Thyson"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all(here::here())
# library(climateapp)
library(dplyr)
```

## Main script

Note that the actual main script that executes a particular "app usage run" can
be found at `/inst/app/01-main.R`.

The following code simply serves as a more illustrative explanation of how the
individual app parts are linked to each other

## Settings

```{r settings}
settings <- default_settings()
set_global_data_repo("repo_1", settings = settings)
```

## Load DB data

```{r load}
source(here::here("inst/app/04-load.R"))
```

This script loads the following three data objects:

1. Database table for measures

```{r load_2}
dat_db %>% glimpse()
dat_db %>% head()
```

2. Database table for stations 

```{r load_3}
dat_station %>% glimpse()
dat_station %>% head()
```

## Example user input

```{r user_input}
source(here::here("inst/app/05-user_input.R"))
```

Open script `inst/app/5-user_input.R` to change the example user input

1. Top level input

```{r user_input-2}
knn
dist_measures
dist_measure_final
```

2. Actual numeric input

```{r user_input-3}
dat_input %>% glimpse()
dat_input %>% head()
```

## Recommendation object {.tabset}

### Estimation

Actual estimation and prediction based on distance measures

```{r recommendation}
source(here::here("inst/app/06-model.R"))
```

### Estimation object: raw

Inspect recommendation results "as is" (i.e. complete data structure, not
optimized for "nice output"" yet)

```{r recommendation_output}
model_result_gathered %>% glimpse()
model_result_gathered
```

### Estimation object: rendered{.tabset}

#### Inputs

```{r recommendation_obj_1}
model_result_gathered$input %>% 
  DT::datatable(
    options = list(
      scrollX = TRUE
    )
  )
```

#### Raw predictions

```{r recommendation_obj_2}
model_result_gathered$prediction %>% 
  DT::datatable(
    options = list(
      scrollX = TRUE
    )
  )
```

#### Ensemble preditions

```{r recommendation_obj_3}
model_result_gathered$prediction_ensemble %>% 
  DT::datatable(
    options = list(
      scrollX = TRUE
    )
  )
```

## Some background on distance measures

- [Euclidean and manhattan distance (video)](https://www.youtube.com/watch?v=aBhmeTAuFZI)
- [Euclidean distance](https://en.wikipedia.org/wiki/Euclidean_distance)
- [Manhattan distance](https://en.wikipedia.org/wiki/Taxicab_geometry)
